<script type="module">
  // ... (keep all existing imports and Firebase initialization code)

  // Modify the checkAnswer function as follows:
  function checkAnswer() {
    const inputs = document.querySelectorAll("#input-container input");
    let allCorrect = true;
    const feedbackEl = document.getElementById("feedback");
    const submitBtn = document.getElementById("submit-btn");

    feedbackEl.innerHTML = "";

    for (let i = 0; i < inputs.length; i++) {
      const userAnswer = inputs[i].value.trim();
      const correctAnswer = currentBlanks[i];
      
      if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
        feedbackEl.innerHTML += `<p>Blank #${i+1}: ✅ Correct! (${correctAnswer})</p>`;
      } else {
        allCorrect = false;
        feedbackEl.innerHTML += `<p>Blank #${i+1}: ❌ Incorrect. The answer was "${correctAnswer}"</p>`;
      }
    }

    if (allCorrect) {
      // Correct answer handling (keep existing code)
      incorrectStreak = 0;
      const pointsEarned = 1 + currentLevel;
      score += pointsEarned;
      levelScore += pointsEarned;
      
      currentVerseIndex++;
      if (currentVerseIndex < currentLevel) {
        setTimeout(() => {
          feedbackEl.innerHTML = "";
          loadNextVerse();
        }, 3000);
      } else {
        completeLevel();
      }
    } else {
      // Incorrect answer handling - modified
      incorrectStreak++;
      lives--;
      updateHearts();
      
      // Change button to Retry and update its functionality
      submitBtn.textContent = "Retry";
      submitBtn.removeEventListener('click', checkAnswer);
      submitBtn.addEventListener('click', retryVerse);
      
      feedbackEl.innerHTML += `<p>Try again! Lives left: ${lives}</p>`;
      
      // Check if game over
      if (lives <= 0) {
        setTimeout(() => {
          gameOver();
        }, 1500);
      }
    }
  }

  // Add this new retryVerse function
  function retryVerse() {
    const submitBtn = document.getElementById("submit-btn");
    const feedbackEl = document.getElementById("feedback");
    
    // Reset button back to Submit
    submitBtn.textContent = "Submit";
    submitBtn.removeEventListener('click', retryVerse);
    submitBtn.addEventListener('click', checkAnswer);
    
    // Clear feedback
    feedbackEl.innerHTML = "";
    
    // Reload the same verse
    loadCurrentVerse();
  }

  // Add this helper function to reload the current verse
  function loadCurrentVerse() {
    // Get the current verse index and reload it
    const currentVerse = usedVerseIndices[currentVerseIndex];
    const verse = bibleVerses[currentVerse];
    
    // Recreate the display with blanks (same as loadNextVerse but without incrementing)
    let displayText = "";
    const words = verse.verse.split(" ");
    let blankCount = 0;
    
    for (let i = 0; i < words.length; i++) {
      if (currentBlanks.includes(words[i].replace(/[.,;!?]/g, ""))) {
        displayText += `<span class="blank">______</span> `;
        blankCount++;
      } else {
        displayText += words[i] + " ";
      }
    }

    document.getElementById("verse").innerHTML = `
      <p>${displayText}</p>
      <p class="reference">${verse.reference}</p>
    `;

    // Recreate input fields
    const inputContainer = document.getElementById("input-container");
    inputContainer.innerHTML = "";
    for (let i = 0; i < blankCount; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = `Blank #${i+1}`;
      input.dataset.index = i;
      inputContainer.appendChild(input);
      if (i === 0) input.focus();
    }
  }

  // ... (keep all other existing functions)
</script>